#!/bin/bash

gcc_flags="-std=c++0x -pedantic -Wall -Wextra -g -O0 -I/opt/local/include/ -fpermissive"

gcc_found=$(find /bin/ /usr/bin /opt/bin /opt/local/bin -regex "^.*g\+\+.*$" 2>/dev/null)

gcc_selected=""

function compatibility_test()
{
	if $1 $gcc_flags -o cpp0x_test cpp0x_test.cpp &>/dev/null ; then
		if test "$(./cpp0x_test)" "!=" "yes" ; then
			return -1
		else
			return 0
		fi
	fi
}

for i in $gcc_found ; do
	version=$($i -v 2>&1 | grep -oE "gcc version [0-9](\.[0-9]){2}" | grep -oE "[0-9](\.[0-9]){2}")
	if test "!" $version "<" 4.6.0 ; then
		if compatibility_test "$i" ; then
			gcc_selected=$i
			break
		fi
	fi
done

if test -z "$gcc_selected" ; then
	echo "no GCC >= 4.6.0 found ... quit"
	exit
fi

echo "selected = $gcc_selected"

#echo "GCC = $GCC"

rm -f Makefile.rules &>/dev/null
echo "CXX = $gcc_selected" >> Makefile.rules
echo "CXXFLAGS = $gcc_flags" >> Makefile.rules
echo "LIBS = -L/opt/local/lib -lboost_thread-mt" >> Makefile.rules

echo "done"
